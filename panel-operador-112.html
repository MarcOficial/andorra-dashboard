<ul id="listaUnidades" class="list-group mb-3"></ul>

<!-- Menú contextual -->
<div id="menuUnidad" class="card shadow position-absolute d-none" style="z-index:1000;">
  <ul class="list-group list-group-flush">
    <li class="list-group-item menu-opcion" data-accion="adjuntarLlamada">Adjuntar a llamada</li>
    <li class="list-group-item menu-opcion" data-accion="adjuntarGrupo">Adjuntar a grupo</li>
    <li class="list-group-item menu-opcion" data-accion="buscar">Buscar</li>
    <li class="list-group-item menu-opcion" data-accion="tableroTonos">Tablero de tonos</li>
    <li class="list-group-item" data-accion="temporizadores">Temporizadores</li>
    <li class="list-group-item menu-opcion" data-accion="modificar">Modificar unidad</li>
    <li class="list-group-item menu-opcion" data-accion="panico">Activar pánico</li>
    <li class="list-group-item menu-opcion" data-accion="sacar">Sacar unidad</li>
  </ul>
</div>

<script>
const listaUnidades = document.getElementById("listaUnidades");
const menuUnidad = document.getElementById("menuUnidad");
let unidadSeleccionada = null;

// Mostrar menú al hacer click en unidad
function renderUnidades() {
  const unidades = JSON.parse(localStorage.getItem("unidades")) || [];
  listaUnidades.innerHTML = "";
  if(unidades.length === 0){
    const li = document.createElement("li");
    li.textContent = "No hay unidades activas";
    li.className = "list-group-item text-muted";
    listaUnidades.appendChild(li);
    return;
  }
  unidades.forEach((u, index) => {
    const li = document.createElement("li");
    li.className = "list-group-item unidad-item";
    li.textContent = `${u.agencia} - ${u.departamento} - ${u.subdivision} (${u.estatus})`;
    li.addEventListener("click", e => {
      unidadSeleccionada = index;
      menuUnidad.style.top = `${e.pageY}px`;
      menuUnidad.style.left = `${e.pageX}px`;
      menuUnidad.classList.remove("d-none");
    });
    listaUnidades.appendChild(li);
  });
}

document.addEventListener("click", e => {
  if(!e.target.classList.contains("unidad-item") && !menuUnidad.contains(e.target)){
    menuUnidad.classList.add("d-none");
  }
});

// Acciones del menú
menuUnidad.querySelectorAll(".menu-opcion").forEach(op => {
  op.addEventListener("click", () => {
    const accion = op.dataset.accion;
    const unidades = JSON.parse(localStorage.getItem("unidades")) || [];
    const u = unidades[unidadSeleccionada];

    switch(accion){
      case "adjuntarLlamada":
        alert(`Unidad ${u.numero} adjuntada a llamada.`);
        break;
      case "adjuntarGrupo":
        alert(`Unidad ${u.numero} adjuntada a grupo.`);
        break;
      case "buscar":
        alert(`Buscando información de ${u.numero}...`);
        break;
      case "tableroTonos":
        alert(`Mostrando tablero de tonos de ${u.numero}`);
        break;
      case "modificar":
        // Abrir modal NOT SET con datos
        document.getElementById("numeroUnidad").value = u.numero;
        document.getElementById("nombreUnidad").value = u.nombre;
        document.getElementById("rangoUnidad").value = u.rango;
        document.getElementById("estatusUnidad").value = u.estatus;
        document.getElementById("ubicacionUnidad").value = u.ubicacion;
        document.getElementById("agenciaUnidad").value = u.agencia;
        document.getElementById("agenciaUnidad").dispatchEvent(new Event("change"));
        document.getElementById("departamentoUnidad").value = u.departamento;
        document.getElementById("departamentoUnidad").dispatchEvent(new Event("change"));
        document.getElementById("subdivisionUnidad").value = u.subdivision;
        new bootstrap.Modal(document.getElementById("modalUnidad")).show();
        break;
      case "panico":
        u.estatus = "PÁNICO";
        localStorage.setItem("unidades", JSON.stringify(unidades));
        renderUnidades();
        alert(`¡Unidad ${u.numero} en PÁNICO!`);
        break;
      case "sacar":
        unidades.splice(unidadSeleccionada,1);
        localStorage.setItem("unidades", JSON.stringify(unidades));
        renderUnidades();
        break;
    }
    menuUnidad.classList.add("d-none");
  });
});

renderUnidades();
</script>
